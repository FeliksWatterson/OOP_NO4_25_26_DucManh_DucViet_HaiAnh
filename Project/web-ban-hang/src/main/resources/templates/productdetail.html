<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${product.name} + ' - Mộc E-commerce'">
      Chi tiết sản phẩm
    </title>

    <link
      rel="shortcut icon"
      th:href="@{/images/logo/favicon.svg}"
      type="image/x-icon"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/productdetail.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header th:replace="~{fragment/header :: header}"></header>

    <main>
      <div class="container">
        <div class="breadcrumbs">
          <a th:href="@{/}">Trang chủ</a>
          <ion-icon name="chevron-forward-outline"></ion-icon>
          <a
            th:if="${product.category != null}"
            href="#"
            th:text="${product.category}"
          >
            Danh mục
          </a>
          <ion-icon
            name="chevron-forward-outline"
            th:if="${product.category != null}"
          ></ion-icon>
          <span th:text="${product.name}">Tên sản phẩm</span>
        </div>

        <div class="product-detail-container">
          <div class="product-image-section">
            <div class="product-main-image">
              <img
                th:src="${product.imageUrl != null ? product.imageUrl : '/images/placeholder.png'}"
                th:alt="${product.name}"
              />
            </div>
          </div>
          <div class="product-info-section">
            <h1 class="product-title" th:text="${product.name}">
              Tên sản phẩm
            </h1>
            <p class="product-sku" th:text="'Mã sản phẩm: SP' + ${product.id}">
              Mã sản phẩm: SP001
            </p>

            <div class="product-price">
              <span
                th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"
              >
              </span>
              <span
                class="original"
                th:if="${product.originalPrice != null and product.originalPrice > product.price}"
                th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"
              >
              </span>
            </div>

            <div class="extra-info">
              <p>
                <ion-icon name="paper-plane-outline"></ion-icon>
                Giao hàng toàn quốc.
              </p>
              <p>
                <ion-icon name="shield-checkmark-outline"></ion-icon>
                Kiểm tra sản phẩm khi giao đến.
              </p>
              <p>
                <ion-icon name="return-up-back-outline"></ion-icon>
                Đổi size/mẫu trong vòng 14 ngày.
              </p>
            </div>

            <form th:action="@{/cart/add}" method="post">
              <input type="hidden" name="productId" th:value="${product.id}" />

              <div class="quantity-selector">
                <label for="quantity">Số lượng:</label>
                <div class="quantity-controls">
                  <button
                    type="button"
                    class="quantity-btn minus"
                    onclick="adjustQty(-1)"
                  >
                    -
                  </button>
                  <input
                    type="number"
                    id="quantity"
                    name="quantity"
                    value="1"
                    min="1"
                    th:max="${product.stock > 0 ? product.stock : 1}"
                    th:attr="data-max=${product.stock > 0 ? product.stock : 1}"
                  />
                  <button
                    type="button"
                    class="quantity-btn plus"
                    onclick="adjustQty(1)"
                  >
                    +
                  </button>
                </div>
                <span
                  class="stock-info"
                  th:text="${'(Còn ' + (product.stock != null and product.stock > 0 ? product.stock : 0) + ' sản phẩm)'}"
                ></span>
              </div>

              <div class="action-buttons">
                <button type="submit" class="btn-add-to-cart">
                  <ion-icon
                    name="cart-outline"
                    style="margin-right: 5px; vertical-align: middle"
                  ></ion-icon>
                  Thêm vào giỏ hàng
                </button>
              </div>
            </form>
            <div class="action-buttons" style="margin-top: 10px">
              <button type="button" class="btn-buy-now">Mua ngay</button>
            </div>
          </div>
        </div>
        <div class="product-description">
          <h3>Mô tả sản phẩm</h3>
          <p
            th:utext="${product.description != null and not #strings.isEmpty(product.description)
              ? #strings.replace(product.description, '\n', '<br/>')
              : 'Chưa có mô tả cho sản phẩm này.'}"
          ></p>
        </div>
      </div>
      <div
        th:if="${welcomeMessage}"
        id="welcomeToast"
        class="toast-notification welcome-toast"
        role="alert"
      >
        <div class="toast-icon">
          <ion-icon name="person-circle-outline"></ion-icon>
        </div>
        <div class="toast-detail">
          <p class="toast-message" th:text="${welcomeMessage}"></p>
        </div>
        <button
          type="button"
          class="toast-close-btn"
          onclick="this.parentElement.style.display='none';"
        >
          <ion-icon name="close-outline"></ion-icon>
        </button>
      </div>

      <div
        th:if="${cartSuccessMessage}"
        id="cartSuccessToast"
        class="toast-notification cart-success-toast"
        role="alert"
      >
        <div class="toast-icon">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
        </div>
        <div class="toast-detail">
          <p class="toast-message" th:text="${cartSuccessMessage}"></p>
        </div>
        <button
          type="button"
          class="toast-close-btn"
          onclick="this.parentElement.style.display='none';"
        >
          <ion-icon name="close-outline"></ion-icon>
        </button>
      </div>

      <div
        th:if="${cartErrorMessage}"
        id="cartErrorToast"
        class="toast-notification cart-error-toast"
        role="alert"
      >
        <div class="toast-icon">
          <ion-icon name="alert-circle-outline"></ion-icon>
        </div>
        <div class="toast-detail">
          <p class="toast-message" th:text="${cartErrorMessage}"></p>
        </div>
        <button
          type="button"
          class="toast-close-btn"
          onclick="this.parentElement.style.display='none';"
        >
          <ion-icon name="close-outline"></ion-icon>
        </button>
      </div>
    </main>

    <footer th:replace="~{fragment/footer :: footer}"></footer>

    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <script th:src="@{/js/script.js}"></script>

    <script>
      function adjustQty(amount) {
        const qtyInput = document.getElementById("quantity");
        const maxQty = parseInt(qtyInput.getAttribute("data-max")) || 1;
        let currentQty = parseInt(qtyInput.value);
        let newQty = currentQty + amount;

        if (newQty < 1) newQty = 1;
        else if (newQty > maxQty) newQty = maxQty;
        qtyInput.value = newQty;
      }

      const qtyInput = document.getElementById("quantity");
      qtyInput.addEventListener("change", function () {
        const maxQty = parseInt(this.getAttribute("data-max")) || 1;
        let value = parseInt(this.value);
        if (isNaN(value) || value < 1) this.value = 1;
        else if (value > maxQty) this.value = maxQty;
      });
    </script>
  </body>
</html>
