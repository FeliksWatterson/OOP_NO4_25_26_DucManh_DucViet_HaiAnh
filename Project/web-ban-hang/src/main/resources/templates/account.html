<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tài khoản - Mộc E-commerce</title>
    <link
      rel="shortcut icon"
      th:href="@{/images/logo/favicon.svg}"
      type="image/x-icon"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/account.css}" />
    <link rel="stylesheet" th:href="@{/css/cart.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header th:replace="~{fragment/header :: header}"></header>

    <main class="account-main">
      <div class="container">
        <div class="breadcrumbs">
          <a th:href="@{/}">Trang chủ</a>
          <ion-icon name="chevron-forward-outline"></ion-icon>
          <a th:href="@{/account}">Tài khoản</a>
          <ion-icon name="chevron-forward-outline"></ion-icon>

          <span id="breadcrumb-section-name">
            <span
              th:if="${showChangePasswordFormOnLoad == true or showChangePasswordForm == true}"
              >Đổi mật khẩu</span
            >
            <span
              th:unless="${showChangePasswordFormOnLoad == true or showChangePasswordForm == true}"
              >Thông tin cá nhân</span
            >
          </span>
        </div>
        <div class="account-container">
          <div class="account-content">
            <div class="account-overview-cards">
              <a
                href="#"
                class="account-card overview-card"
                style="text-decoration: none"
                onclick="showSection('orderHistory'); return false;"
              >
                <div class="card-icon">
                  <ion-icon name="document-text-outline"></ion-icon>
                  <span
                    class="badge"
                    th:if="${not #lists.isEmpty(orders)}"
                    th:text="${#lists.size(orders)}"
                    >0</span
                  >
                </div>
                <p>Lịch sử đơn hàng</p>
              </a>
              <div class="account-card overview-card">
                <div class="card-icon">
                  <ion-icon name="happy-outline"></ion-icon>
                </div>
                <p th:text="'Hi, ' + ${customer.fullName} + '!'"></p>
              </div>
            </div>

            <div
              class="info-card content-section active-section"
              id="personalInfoContent"
            >
              <h3>Thông tin cá nhân</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Họ và tên:</span>
                  <span class="info-value" th:text="${customer.fullName}"
                    >...</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Email:</span>
                  <span class="info-value" th:text="${customer.email}"
                    >...</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Số điện thoại:</span>
                  <span
                    class="info-value"
                    th:text="${defaultAddress?.phone ?: customer.phone ?: 'Chưa cập nhật'}"
                    >...</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Địa chỉ mặc định:</span>
                  <span
                    class="info-value"
                    th:text="${defaultAddress?.getFullShippingAddress() ?: 'Chưa có địa chỉ mặc định'}"
                    >Vietnam</span
                  >
                </div>
              </div>
              <a th:href="@{/account/address}" class="edit-btn"
                >Chỉnh sửa thông tin</a
              >
            </div>

            <div
              class="info-card content-section"
              id="changePasswordContent"
              style="display: none"
            >
              <h3>Đổi mật khẩu</h3>
              <form
                th:action="@{/account/change-password}"
                method="post"
                class="password-form"
              >
                <div class="info-grid">
                  <div class="form-group">
                    <label for="oldPassword">Mật khẩu cũ:</label>
                    <input
                      type="password"
                      id="oldPassword"
                      name="oldPassword"
                      required
                    />
                  </div>
                  <div></div>
                  <div class="form-group">
                    <label for="newPassword">Mật khẩu mới:</label>
                    <input
                      type="password"
                      id="newPassword"
                      name="newPassword"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="confirmPassword">Xác nhận mật khẩu mới:</label>
                    <input
                      type="password"
                      id="confirmPassword"
                      name="confirmPassword"
                      required
                    />
                  </div>
                </div>
                <p
                  th:if="${passwordError}"
                  style="color: red; margin-top: 10px"
                  th:text="${passwordError}"
                ></p>
                <p
                  th:if="${passwordSuccess}"
                  style="color: green; margin-top: 10px"
                  th:text="${passwordSuccess}"
                ></p>

                <button type="submit" class="edit-btn" style="margin-top: 20px">
                  Lưu thay đổi
                </button>
              </form>
            </div>

            <div
              class="order-history-content account-card content-section"
              id="orderHistoryContent"
            >
              <h2>Lịch Sử Đơn Hàng</h2>
              <div th:if="${not #lists.isEmpty(orders)}">
                <table class="order-table">
                  <thead>
                    <tr>
                      <th>Mã Đơn Hàng</th>
                      <th>Ngày Đặt</th>
                      <th>Địa chỉ giao hàng</th>
                      <th>Tổng Tiền</th>
                      <th>Trạng Thái</th>
                      <th>Chi tiết</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="order : ${orders}">
                      <td class="order-id" th:text="'#' + ${order.id}">#123</td>
                      <td
                        th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"
                      >
                        dd/MM/yyyy HH:mm
                      </td>
                      <td th:text="${order.shippingAddress}">Địa chỉ...</td>
                      <td
                        th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                      >
                        100.000 đ
                      </td>
                      <td class="order-status" th:text="${order.status}">
                        Đặt hàng thành công
                      </td>
                      <td>
                        <button
                          type="button"
                          class="view-details-btn"
                          th:attr="data-modal-target='#order-details-' + ${order.id}"
                        >
                          Xem
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div th:if="${#lists.isEmpty(orders)}" class="no-orders">
                <p>Bạn chưa có đơn hàng nào.</p>
              </div>
            </div>
          </div>

          <div class="account-sidebar">
            <div class="account-card sidebar-card">
              <nav class="sidebar-nav">
                <ul>
                  <li>
                    <a
                      href="#"
                      class="active"
                      onclick="showSection('personalInfo'); return false;"
                    >
                      <ion-icon name="person-outline"></ion-icon>
                      <span>Thông tin cá nhân</span>
                    </a>
                  </li>
                  <li>
                    <a th:href="@{/account/address}">
                      <ion-icon name="location-outline"></ion-icon>
                      <span th:text="|Quản lý địa chỉ (${addressCount})|"
                        >Quản lý địa chỉ (0)</span
                      >
                    </a>
                  </li>
                  <li>
                    <a
                      href="#"
                      onclick="showSection('orderHistory'); return false;"
                    >
                      <ion-icon name="document-text-outline"></ion-icon>
                      <span>Lịch sử đơn hàng</span>
                    </a>
                  </li>
                  <li>
                    <a th:href="@{/account/change-password}">
                      <ion-icon name="lock-closed-outline"></ion-icon>
                      <span>Đổi mật khẩu</span>
                    </a>
                  </li>
                  <li>
                    <a
                      href="#"
                      onclick="confirmAccountDeletion(); return false;"
                    >
                      <ion-icon name="trash-outline"></ion-icon>
                      <span>Xóa tài khoản</span>
                    </a>
                    <form
                      id="deleteAccountForm"
                      th:action="@{/account/delete}"
                      method="post"
                      style="display: none"
                    ></form>
                  </li>
                  <li>
                    <a th:href="@{/logout}">
                      <ion-icon name="log-out-outline"></ion-icon>
                      <span>Đăng xuất</span>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer th:replace="~{fragment/footer :: footer}"></footer>

    <div th:each="order : ${orders}">
      <div
        class="modal-overlay"
        th:id="'order-details-' + ${order.id} + '-overlay'"
      ></div>

      <div class="modal-content" th:id="'order-details-' + ${order.id}">
        <button type="button" class="modal-close-btn">&times;</button>

        <div class="order-details-summary">
          <h3 th:text="|Chi tiết đơn hàng #${order.id}|">Chi tiết đơn hàng</h3>
          <p
            th:text="|Ngày tạo: ${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}|"
          >
            Ngày tạo
          </p>

          <div class="shipping-info">
            <p>
              <strong>Người nhận:</strong>
              <span th:text="${order.fullName}"></span>
            </p>
            <p>
              <strong>Điện thoại:</strong>
              <span th:text="${order.phone}"></span>
            </p>
            <p>
              <strong>Địa chỉ:</strong>
              <span th:text="${order.shippingAddress}"></span>
            </p>
            <p>
              <strong>Phương thức TT:</strong>
              <span
                th:text="${order.paymentMethod == 'cod' ? 'Thanh toán khi nhận hàng (COD)' : 'Thanh toán VNPay'}"
              ></span>
            </p>
            <p
              th:if="${order.note != null and not #strings.isEmpty(order.note)}"
            >
              <strong>Ghi chú:</strong> <span th:text="${order.note}"></span>
            </p>
          </div>

          <div class="summary-items">
            <div th:each="item : ${order.orderItems}" class="summary-item">
              <div class="summary-item-image">
                <img
                  th:src="${item.product.imageUrl ?: '/images/placeholder.png'}"
                  th:alt="${item.product.name}"
                />
              </div>
              <div class="summary-item-details">
                <span
                  class="summary-item-name"
                  th:text="${item.product.name}"
                ></span>
                <span
                  class="summary-item-qty"
                  th:text="|SL: ${item.quantity} x ${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}đ|"
                ></span>
              </div>
              <span
                class="summary-item-price"
                th:text="${#numbers.formatDecimal(item.getSubtotal(), 0, 'COMMA', 0, 'POINT')} + ' đ'"
              ></span>
            </div>
          </div>

          <div class="summary-totals">
            <div class="summary-row">
              <span>Tổng sản phẩm</span>
              <span
                th:text="${#numbers.formatDecimal(order.totalAmount - order.shippingFee + order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'"
              ></span>
            </div>
            <div class="summary-row">
              <span>Vận chuyển</span>
              <span
                th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' đ'"
              ></span>
            </div>
            <div class="summary-row" th:if="${order.discountAmount > 0}">
              <span>Giảm giá</span>
              <span
                th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'"
              ></span>
            </div>
            <div class="summary-row total-row">
              <span>Tổng tiền</span>
              <span
                class="final-total"
                th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'"
              ></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script th:src="@{/js/script.js}"></script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <script th:inline="javascript">
      function showSection(sectionId) {
        document
          .querySelectorAll(".account-content > .content-section")
          .forEach((div) => {
            div.classList.remove("active-section");
            div.style.display = "none";
          });

        const sectionToShow = document.getElementById(sectionId + "Content");
        if (sectionToShow) {
          sectionToShow.classList.add("active-section");
          sectionToShow.style.display = "block";
        }

        const breadcrumbSpan = document.getElementById(
          "breadcrumb-section-name"
        );
        if (breadcrumbSpan) {
          if (sectionId === "personalInfo") {
            breadcrumbSpan.textContent = "Thông tin cá nhân";
          } else if (sectionId === "changePassword") {
            breadcrumbSpan.textContent = "Đổi mật khẩu";
          } else if (sectionId === "orderHistory") {
            breadcrumbSpan.textContent = "Lịch sử đơn hàng";
          }
        }

        document.querySelectorAll(".sidebar-nav li a").forEach((link) => {
          link.classList.remove("active");
          const linkPath = link.getAttribute("href");
          const onclickAttr = link.getAttribute("onclick");

          let isMatch = false;
          if (
            linkPath &&
            linkPath.includes("/account/change-password") &&
            sectionId === "changePassword"
          ) {
            isMatch = true;
          } else if (
            linkPath &&
            linkPath.includes("/account/address") &&
            sectionId === "address"
          ) {
            isMatch = true;
          } else if (
            onclickAttr &&
            onclickAttr.includes(`showSection('${sectionId}')`)
          ) {
            isMatch = true;
          }

          if (isMatch) {
            link.classList.add("active");
          }
        });

        if (
          !document.querySelector(".sidebar-nav li a.active") &&
          sectionId !== "address"
        ) {
          const infoLink = document.querySelector(
            ".sidebar-nav li a[onclick*=\"showSection('personalInfo')\"]"
          );
          if (infoLink) infoLink.classList.add("active");
        }
      }

      function confirmAccountDeletion() {
        if (
          confirm(
            "Bạn có chắc chắn muốn xóa tài khoản này không? Hành động này không thể hoàn tác và sẽ xóa tất cả dữ liệu liên quan."
          )
        ) {
          document.getElementById("deleteAccountForm").submit();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const showPasswordFormOnLoad = /*[[${showChangePasswordFormOnLoad}]]*/ false;
        const showPasswordFormAfterAction = /*[[${showChangePasswordForm}]]*/ false;
        const sectionToDisplayFromSession =
          sessionStorage.getItem("showSection");

        let initialSection = "personalInfo";

        if (showPasswordFormOnLoad || showPasswordFormAfterAction) {
          initialSection = "changePassword";
        } else if (sectionToDisplayFromSession === "orderHistory") {
          initialSection = "orderHistory";
          sessionStorage.removeItem("showSection");
        }

        showSection(initialSection);

        const alerts = document.querySelectorAll(
          ".alert-success, .alert-danger"
        );
        alerts.forEach((alert) => {
          if (alert.textContent.trim()) {
            setTimeout(() => {
              alert.style.transition = "opacity 0.5s ease";
              alert.style.opacity = "0";
              setTimeout(() => (alert.style.display = "none"), 500);
            }, 5000);
          } else {
            alert.style.display = "none";
          }
        });

        const viewButtons = document.querySelectorAll(".view-details-btn");
        const modalOverlays = document.querySelectorAll(".modal-overlay");
        const modalCloseButtons = document.querySelectorAll(".modal-close-btn");

        viewButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const modalTargetId = button.dataset.modalTarget;
            const modal = document.querySelector(modalTargetId);
            const overlay = document.querySelector(modalTargetId + "-overlay");

            if (modal && overlay) {
              modal.classList.add("active");
              overlay.classList.add("active");
            }
          });
        });

        modalCloseButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const modal = button.closest(".modal-content");
            const overlay = document.querySelector("#" + modal.id + "-overlay");

            modal.classList.remove("active");
            if (overlay) overlay.classList.remove("active");
          });
        });

        modalOverlays.forEach((overlay) => {
          overlay.addEventListener("click", () => {
            const modalId = overlay.id.replace("-overlay", "");
            const modal = document.querySelector("#" + modalId);

            overlay.classList.remove("active");
            if (modal) modal.classList.remove("active");
          });
        });
      });
    </script>
  </body>
</html>
